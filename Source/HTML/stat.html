<!doctype html>
<html>
<head>
    <title>STATS</title>
    <meta charset='utf-8' />
</head>
<body>


<DIV id="status"></DIV>



<!--<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>-->
<script type="text/javascript">
    function SetStatus(Str)
    {
        var id = document.getElementById("status");
        id.innerText=Str;
    }


//    google.charts.load('current', {'packages':['corechart']});
//    google.charts.setOnLoadCallback(InitChart);

    var CanRedraw=true;
    var ChartDgrm;
    var DataChart,DataChartConfirmation;
    var ChartConfirm;
    function InitChart()
    {
        ChartDgrm = new google.visualization.SteppedAreaChart(document.getElementById('chart_div'));
        GetStat();

        //ChartConfirm = new google.visualization.SteppedAreaChart(document.getElementById('confirm_div'));
    }

    function drawChart(arr,arrnames,arrmult)
    {
        var StrFilter = document.getElementById("idFilter").value;
        var mas=[];
        for(var i=0;i<arr.length;i++)
        {
            var arr_stat=arr[i];
            if(i===0)
            {
                var row=['Период'];
                for(var name in arr_stat)
                {
                    if(StrFilter.length>0 && name.indexOf(StrFilter)==-1)
                        continue;

                    if(name.indexOf("MAX:")!==-1)
                        continue;

                    row.push(name);
                }
                mas.push(row);
            }
            var row=[arrnames[i]];
            for(var name in arr_stat)
            {
                if(StrFilter.length>0 && name.indexOf(StrFilter)==-1)
                    continue;

                if(name.indexOf("MAX:")!==-1)
                    continue;

                row.push(Math.floor(arr_stat[name]/arrmult[i]));
            }

            mas.push(row);
        }

        DataChart=google.visualization.arrayToDataTable(mas);

        var options = {
            title: 'Statistics',
            vAxis: {title: 'Avarage values per 10 sec'},
            //backgroundColor: '#ddd',
            legend: {position: 'top', maxLines: 5},
            connectSteps: true,
            isStacked: true,
        };


        google.visualization.events.addListener(ChartDgrm, 'onmouseover', function (pos)
        {
            CanRedraw=false;
            //SetStatus("onmouseover="+JSON.stringify(pos));
        });
        google.visualization.events.addListener(ChartDgrm, 'onmouseout', function (pos)
        {
            CanRedraw=true;
            //SetStatus("onmouseout="+JSON.stringify(pos));
        });

        if(CanRedraw)
            ChartDgrm.draw(DataChart, options);

    }

    function drawChartConfirmation(arr)
    {
        return;

        var mas=[];
        for(var i=0;i<arr.length;i++)
        {
            var arr_stat=arr[i];
            if(i===0)
            {
                var row=['Высота','Норма','Превышение'];
                mas.push(row);
            }
            var val1=arr[i];
            var val2=0;
            if(val1===0)
            {
                val1=8;
            }
            if(val1>8)
            {
                val2=val1-8;
                val1=8;
            }
            var row=[i,val1,val2];
            mas.push(row);
        }

        DataChartConfirmation=google.visualization.arrayToDataTable(mas);

        var options = {
            title: 'Подтверждение блоков последние 10 минут',
            vAxis: {title: 'Высота', titleTextStyle: {color: '#000'}},
            legend: {position: 'none'},
            isStacked: true,
            height: 200,
            connectSteps: true,
        };


        ChartConfirm.draw(DataChartConfirmation, options);

    }

    function SetResult(Data)
    {

        //drawChartConfirmation(Data.Confirmation);


        var arrnames=["10s","10m","total, avg"];
        var arrmult=[10,10*60,Data.period*10];
        for(var i=0;i<arrmult.length;i++)
        {
            if(arrmult[i]>Data.period)
                arrmult[i]=Data.period;

            arrmult[i]=arrmult[i]/10;
        }


//        var arrdata=[Data.stats.Counter10S,Data.stats.Counter10M,Data.stats.Counter1H,Data.stats.Counter];
//        var arrerr=[Data.errors.Counter10S,Data.errors.Counter10M,Data.errors.Counter1H,Data.errors.Counter];
        var arrdata=[Data.stats.Counter10S,Data.stats.Counter10M,Data.stats.Counter];
        var arrerr=[Data.errors.Counter10S,Data.errors.Counter10M,Data.errors.Counter];
        //drawChart(arrdata,arrnames,arrmult);


        SetStat(document.getElementById("grid_stat"),arrdata);
        SetStat(document.getElementById("grid_error"),arrerr);
    }
    function SetStat(htmlTable,arr)
    {
        var StrFilter = document.getElementById("idFilter").value;

        var rows=htmlTable.rows;
        if(!htmlTable.StatItem)
        {
            htmlTable.StatItem={};
            htmlTable.StatItem["Total"]=rows[1];
        }

        for(var i=1;i<rows.length;i++)
            for(var j=1;j<rows[i].cells.length;j++)
                rows[i].cells[j].innerText="";

        for(var m=0;m<arr.length;m++)
        {
            var Data=arr[m];
            var Sum=0;
            for(var name in Data)
            {
                if(name.indexOf("MAX:")!==-1)
                    continue;
                var Count=Data[name];
                if(Count)
                {
                    Sum+=parseInt(Count);
                }
            }
            Data["Total"]=Sum;

            for(var name in Data)
            {

                var item=htmlTable.StatItem[name];
                if(!item)
                {
                    //index=htmlTable.rows.length;

                    var item=htmlTable.insertRow(1);
                    htmlTable.StatItem[name]=item;
                    item.insertCell(0);
                    for(var n=0;n<arr.length;n++)
                    {
                        item.insertCell(n+1);
                    }

                    item.cells[0].innerText=name;
                }


                var Count=Math.floor(Data[name]);
                item.cells[m+1].innerText=Count;
                //item.visibility="visible";

                if(StrFilter.length>0 && name.indexOf(StrFilter)==-1)
                   item.style="display:none";
                else
                    item.style="";

            }
        }
    }

    //LIB

    function GetData(Method, Func)
    {
        var serv=new XMLHttpRequest();
        serv.open("GET", Method, true);
        serv.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        serv.setRequestHeader("If-Modified-Since", "Sat, 1 Jan 2000 00:00:00 GMT");
        serv.onreadystatechange = function()
        {
            if (serv.readyState == 4)
            {
                if(serv.status == 200)
                {
                    if(Func)
                        Func(JSON.parse(serv.responseText));
                }
                else
                {
                    if(Func)
                        Func(undefined);
                }
            }
        }

        serv.send("");
    };




    function GetStat()
    {
        GetData("/total-stats",function (Data)
        {
            //SetResult("Result:"+JSON.stringify(Data));
            SetResult(Data);

        });
    }


    setInterval(GetStat,1000);

    //window.onload=GetStat;


</script>



<style type="text/css">

    table
    {
        border-collapse: collapse;
    }
    .stat th, .stat td {
        border: 1px solid #000;
        padding: 5px;
    }
    .stat td{
        width: 122px;
        text-align: right;
    }
    .stat td:nth-child(1) {
        width: 220px;
    }
    .total {
        text-align: right;
        font-weight: 600;
    }

</style>


<BR>

<div id="confirm_div" style="height: 0px;"></div>

<h3>Статистика</h3>
Фильтр:<INPUT type="string" style="width: 292px" id="idFilter" value="">

    <table id="grid_stat" class="stat">
        <tr>
            <th>Statistic</th>
            <th>10 sec</th>
            <th>10 min</th>
            <th>total</th>
        </tr>
        <tr class="total">
            <td>Total</td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
    </table>

<BR>

    <table id="grid_error" class="stat">
        <tr>
            <th>Error</th>
            <th>10 sec</th>
            <th>10 min</th>
            <th>total</th>
        </tr>
        <tr class="total">
            <td>Total</td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
    </table>



<div id="chart_div" style="width: 900px; height: 500px;"></div>

</body>
</html>

